{"ast":null,"code":"import React,{useEffect,useState}from\"react\";import{getContract}from\"../utils/contract\";import{parseEther}from\"ethers\";import{jsxs as _jsxs,jsx as _jsx,Fragment as _Fragment}from\"react/jsx-runtime\";export default function SettleUpView(_ref){let{signer,group,setView}=_ref;const[balances,setBalances]=useState({});const[recipient,setRecipient]=useState(null);const[amount,setAmount]=useState(\"\");const[isSettling,setIsSettling]=useState(false);const[success,setSuccess]=useState(false);useEffect(()=>{const fetchBalances=async()=>{const addr=(await signer.getAddress()).toLowerCase();const res=await fetch(`http://localhost:5000/api/expenses/group/${group.groupId}/balance`);const balanceMap=await res.json();const owedTo=group.members.filter(member=>{const memberName=member.name;const memberAddr=member.address.toLowerCase();const balance=balanceMap[memberName];return memberAddr!==addr&&balance>0;});const balancesFiltered={};owedTo.forEach(m=>{const amt=balanceMap[m.name];balancesFiltered[m.name]={address:m.address,amount:parseFloat(amt).toFixed(4)};});setBalances(balancesFiltered);const first=Object.keys(balancesFiltered)[0];if(first){setRecipient(first);setAmount(balancesFiltered[first].amount);}};fetchBalances();},[group,signer]);const handleSettle=async()=>{try{setIsSettling(true);const recipientAddress=balances[recipient].address;const ethValue=parseEther(amount.toString());const contract=getContract(signer);const tx=await contract.settleUp(recipientAddress,{value:ethValue});await tx.wait();await fetch(\"http://localhost:5000/api/expenses/settlement\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({groupId:group.groupId,from:(await signer.getAddress()).toLowerCase(),to:balances[recipient].address,amount,txHash:tx.hash})});setSuccess(true);// ‚úÖ Update local balances\nconst updated={...balances};updated[recipient].amount=\"0.0000\";setBalances(updated);// ‚úÖ Redirect back to groups\nsetTimeout(()=>{setView(\"groups\");},1500);}catch(err){console.error(\"Settle failed:\",err);alert(\"‚ùå Transaction failed.\");}finally{setIsSettling(false);}};return/*#__PURE__*/_jsxs(\"div\",{className:\"container mt-5\",children:[/*#__PURE__*/_jsxs(\"h3\",{children:[\"\\uD83D\\uDCB8 Settle Up \\u2013 \",group.groupName]}),Object.keys(balances).length===0?/*#__PURE__*/_jsx(\"p\",{className:\"text-muted mt-4\",children:\"You don\\u2019t owe anyone in this group.\"}):/*#__PURE__*/_jsxs(\"div\",{className:\"mt-4\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-3\",children:[/*#__PURE__*/_jsx(\"label\",{className:\"form-label\",children:\"Select Member\"}),/*#__PURE__*/_jsx(\"select\",{className:\"form-select\",value:recipient,onChange:e=>{setRecipient(e.target.value);setAmount(balances[e.target.value].amount);},disabled:success,children:Object.entries(balances).map(_ref2=>{let[name,info]=_ref2;return/*#__PURE__*/_jsxs(\"option\",{value:name,children:[name,\" \\u2013 \",info.amount,\" ETH\"]},name);})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-3\",children:[/*#__PURE__*/_jsx(\"label\",{className:\"form-label\",children:\"Amount (ETH)\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",className:\"form-control\",value:amount,disabled:true})]}),success?/*#__PURE__*/_jsx(\"div\",{className:\"alert alert-success\",children:\"\\u2705 Payment successful! Redirecting...\"}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-success me-2\",onClick:handleSettle,disabled:isSettling,children:isSettling?\"Settling...\":\"Confirm Payment\"}),/*#__PURE__*/_jsx(\"button\",{className:\"btn btn-outline-secondary\",onClick:()=>setView(\"groups\"),children:\"Cancel\"})]})]})]});}","map":{"version":3,"names":["React","useEffect","useState","getContract","parseEther","jsxs","_jsxs","jsx","_jsx","Fragment","_Fragment","SettleUpView","_ref","signer","group","setView","balances","setBalances","recipient","setRecipient","amount","setAmount","isSettling","setIsSettling","success","setSuccess","fetchBalances","addr","getAddress","toLowerCase","res","fetch","groupId","balanceMap","json","owedTo","members","filter","member","memberName","name","memberAddr","address","balance","balancesFiltered","forEach","m","amt","parseFloat","toFixed","first","Object","keys","handleSettle","recipientAddress","ethValue","toString","contract","tx","settleUp","value","wait","method","headers","body","JSON","stringify","from","to","txHash","hash","updated","setTimeout","err","console","error","alert","className","children","groupName","length","onChange","e","target","disabled","entries","map","_ref2","info","type","onClick"],"sources":["C:/Users/katas/BlockChainProject/expense-splitter-dapp/src/views/SettleUpView.js"],"sourcesContent":["import React, { useEffect, useState } from \"react\";\r\nimport { getContract } from \"../utils/contract\";\r\nimport { parseEther } from \"ethers\";\r\n\r\nexport default function SettleUpView({ signer, group, setView }) {\r\n  const [balances, setBalances] = useState({});\r\n  const [recipient, setRecipient] = useState(null);\r\n  const [amount, setAmount] = useState(\"\");\r\n  const [isSettling, setIsSettling] = useState(false);\r\n  const [success, setSuccess] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const fetchBalances = async () => {\r\n      const addr = (await signer.getAddress()).toLowerCase();\r\n\r\n      const res = await fetch(\r\n        `http://localhost:5000/api/expenses/group/${group.groupId}/balance`\r\n      );\r\n      const balanceMap = await res.json();\r\n\r\n      const owedTo = group.members.filter((member) => {\r\n        const memberName = member.name;\r\n        const memberAddr = member.address.toLowerCase();\r\n        const balance = balanceMap[memberName];\r\n\r\n        return memberAddr !== addr && balance > 0;\r\n      });\r\n\r\n      const balancesFiltered = {};\r\n      owedTo.forEach((m) => {\r\n        const amt = balanceMap[m.name];\r\n        balancesFiltered[m.name] = {\r\n          address: m.address,\r\n          amount: parseFloat(amt).toFixed(4),\r\n        };\r\n      });\r\n\r\n      setBalances(balancesFiltered);\r\n\r\n      const first = Object.keys(balancesFiltered)[0];\r\n      if (first) {\r\n        setRecipient(first);\r\n        setAmount(balancesFiltered[first].amount);\r\n      }\r\n    };\r\n\r\n    fetchBalances();\r\n  }, [group, signer]);\r\n\r\n  const handleSettle = async () => {\r\n    try {\r\n      setIsSettling(true);\r\n      const recipientAddress = balances[recipient].address;\r\n      const ethValue = parseEther(amount.toString());\r\n\r\n      const contract = getContract(signer);\r\n      const tx = await contract.settleUp(recipientAddress, {\r\n        value: ethValue,\r\n      });\r\n\r\n      await tx.wait();\r\n      await fetch(\"http://localhost:5000/api/expenses/settlement\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          groupId: group.groupId,\r\n          from: (await signer.getAddress()).toLowerCase(),\r\n          to: balances[recipient].address,\r\n          amount,\r\n          txHash: tx.hash\r\n        }),\r\n      });\r\n      \r\n      setSuccess(true);\r\n\r\n      // ‚úÖ Update local balances\r\n      const updated = { ...balances };\r\n      updated[recipient].amount = \"0.0000\";\r\n      setBalances(updated);\r\n\r\n      // ‚úÖ Redirect back to groups\r\n      setTimeout(() => {\r\n        setView(\"groups\");\r\n      }, 1500);\r\n    } catch (err) {\r\n      console.error(\"Settle failed:\", err);\r\n      alert(\"‚ùå Transaction failed.\");\r\n    } finally {\r\n      setIsSettling(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"container mt-5\">\r\n      <h3>üí∏ Settle Up ‚Äì {group.groupName}</h3>\r\n\r\n      {Object.keys(balances).length === 0 ? (\r\n        <p className=\"text-muted mt-4\">You don‚Äôt owe anyone in this group.</p>\r\n      ) : (\r\n        <div className=\"mt-4\">\r\n          <div className=\"mb-3\">\r\n            <label className=\"form-label\">Select Member</label>\r\n            <select\r\n              className=\"form-select\"\r\n              value={recipient}\r\n              onChange={(e) => {\r\n                setRecipient(e.target.value);\r\n                setAmount(balances[e.target.value].amount);\r\n              }}\r\n              disabled={success}\r\n            >\r\n              {Object.entries(balances).map(([name, info]) => (\r\n                <option key={name} value={name}>\r\n                  {name} ‚Äì {info.amount} ETH\r\n                </option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          <div className=\"mb-3\">\r\n            <label className=\"form-label\">Amount (ETH)</label>\r\n            <input\r\n              type=\"text\"\r\n              className=\"form-control\"\r\n              value={amount}\r\n              disabled\r\n            />\r\n          </div>\r\n\r\n          {success ? (\r\n            <div className=\"alert alert-success\">\r\n              ‚úÖ Payment successful! Redirecting...\r\n            </div>\r\n          ) : (\r\n            <>\r\n              <button\r\n                className=\"btn btn-success me-2\"\r\n                onClick={handleSettle}\r\n                disabled={isSettling}\r\n              >\r\n                {isSettling ? \"Settling...\" : \"Confirm Payment\"}\r\n              </button>\r\n              <button\r\n                className=\"btn btn-outline-secondary\"\r\n                onClick={() => setView(\"groups\")}\r\n              >\r\n                Cancel\r\n              </button>\r\n            </>\r\n          )}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}